resources:
  cloud: lambda
  cpus: 8+
  disk_size: 200

envs:
  IMAGE_NAME: null
  ARCH: ""
  HF_TOKEN: null

workdir: .

setup: |
  sudo apt-get update
  sudo apt-get install -y software-properties-common
  sudo add-apt-repository -y ppa:apptainer/ppa
  sudo apt-get update
  sudo apt-get install -y apptainer
  pip install --upgrade huggingface_hub
  if [ -n "$ARCH" ]; then
    sudo apt-get install -y qemu-user-static
  fi

run: |
  ARCH_FLAG=""
  if [ -n "$ARCH" ]; then ARCH_FLAG="--arch $ARCH"; fi
  sudo apptainer --verbose build $ARCH_FLAG \
    --mksquashfs-args="-comp gzip -Xcompression-level 1" \
    eval_env-${IMAGE_NAME}.sif containers/${IMAGE_NAME}.def
  huggingface-cli login --token "$HF_TOKEN"
  huggingface-cli upload openeurollm/evaluation_singularity_images \
    eval_env-${IMAGE_NAME}.sif eval_env-${IMAGE_NAME}.sif \
    --repo-type dataset --commit-message "[chore] update ${IMAGE_NAME} image"
