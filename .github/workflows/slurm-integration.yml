name: SLURM Integration Test

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - 'oellm/**'
      - 'tests/integration/**'
      - '.github/workflows/slurm-integration.yml'
      - 'containers/slurm-ci.def'
      - 'sky/slurm-integration.yaml'

jobs:
  slurm-integration:
    name: SLURM Integration (${{ matrix.mode }})
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        mode: [container, venv]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SkyPilot
        uses: ./.github/actions/setup-skypilot
        with:
          lambda_api_key: ${{ secrets.LAMBDA_API_KEY }}

      - name: Run SLURM integration test on Lambda
        run: |
          sky launch -y \
            -c slurm-${{ matrix.mode }}-${{ github.run_id }} \
            --env TEST_MODE=${{ matrix.mode }} \
            sky/slurm-integration.yaml

      - name: Collect logs
        if: always()
        run: |
          CLUSTER=slurm-${{ matrix.mode }}-${{ github.run_id }}
          mkdir -p /tmp/slurm-logs
          sky rsync-down $CLUSTER /tmp/slurm-logs/ /tmp/slurm-logs/ || true

      - name: Teardown Lambda instance
        if: always()
        run: sky down -y slurm-${{ matrix.mode }}-${{ github.run_id }}

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: slurm-logs-${{ matrix.mode }}
          path: /tmp/slurm-logs/
          retention-days: 7
