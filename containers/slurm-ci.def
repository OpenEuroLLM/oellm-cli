Bootstrap: docker
From: nvcr.io/nvidia/pytorch:25.10-py3

%labels
    Author      oellm-cli
    Description Apptainer image for CI integration tests

%post
    # Install uv
    curl -LsSf https://astral.sh/uv/install.sh | env UV_INSTALL_DIR=/usr/local/bin sh
    export UV_TOOL_BIN_DIR=/usr/local/bin
    export UV_TOOL_DIR=/opt/uv-tools

    # lm-eval and dependencies (system Python)
    uv pip install --system --break-system-packages \
        lm-eval \
        transformers \
        "datasets<4.0.0" \
        wandb \
        sentencepiece \
        tiktoken \
        accelerate \
        nltk

    # lighteval as isolated tool (avoids dependency conflicts)
    uv tool install --python 3.12 \
        --with "langcodes[data]" \
        --with "pillow" \
        "lighteval[multilingual] @ git+https://github.com/huggingface/lighteval.git"

    # Pre-load lighteval registry to trigger tinyBenchmarks data download at build time
    /opt/uv-tools/lighteval/bin/python -c "from lighteval.tasks.registry import Registry; Registry.load_all_task_configs(load_multilingual=True)"

    # NLTK data
    mkdir -p /opt/nltk_data
    python -c "import nltk; nltk.download('punkt', download_dir='/opt/nltk_data'); nltk.download('punkt_tab', download_dir='/opt/nltk_data')"

%environment
    export PATH=/usr/local/bin:$PATH
    export UV_TOOL_BIN_DIR=/usr/local/bin
    export UV_TOOL_DIR=/opt/uv-tools
    export NLTK_DATA=/opt/nltk_data

%runscript
    exec bash "$@"
